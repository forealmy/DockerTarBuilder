name: Push Images to Fixed ACR Address

on:
  workflow_dispatch:
    inputs:
      docker_images:
        description: 'Docker é•œåƒåˆ—è¡¨ï¼ˆè‹±æ–‡é€—å·åˆ†éš”ï¼‰'
        required: true
        default: 'nginx:latest,langgenius/dify-api:1.11.2'

jobs:
  push-to-acr:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Push to ACR (Hardcoded Registry)
        env:
          # ğŸ‘‡ ç›´æ¥å†™æ­»ä½ çš„ ACR åœ°å€ï¼ˆregistry + namespaceï¼‰
          ACR_TARGET_REGISTRY: crpi-dsuujqmghq4pfebi.cn-hangzhou.personal.cr.aliyuncs.com/my-dify-prod

          # ğŸ‘‡ ä» Secrets è¯»å– AccessKeyï¼ˆä»…ç”¨äºç™»å½•ï¼‰
          ALIYUN_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          ALIYUN_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
        run: |
          echo "Target ACR: $ACR_TARGET_REGISTRY"

          # æ£€æŸ¥ AK æ˜¯å¦ä¸ºç©ºï¼ˆé˜²é”™ï¼‰
          if [ -z "$ALIYUN_ACCESS_KEY_ID" ] || [ -z "$ALIYUN_ACCESS_KEY_SECRET" ]; then
            echo "âŒ Error: AccessKey ID or Secret is missing. Check GitHub Secrets."
            exit 1
          fi

          # ç™»å½• ACRï¼ˆé˜¿é‡Œäº‘æ”¯æŒç”¨ AK/SK ä½œä¸ºç”¨æˆ·åå¯†ç ï¼‰
          echo "$ALIYUN_ACCESS_KEY_SECRET" | docker login \
           --username "$ALIYUN_ACCESS_KEY_ID" \
           --password-stdin \
           "$(echo "$ACR_TARGET_REGISTRY" | cut -d'/' -f1)"

          IFS=',' read -r -a IMAGES <<< "${{ github.event.inputs.docker_images }}"

          for IMAGE in "${IMAGES[@]}"; do
            IMAGE=$(echo "$IMAGE" | xargs)  # trim
            echo ">>> Processing: $IMAGE"

            # è§£æ tag
            if [[ "$IMAGE" == *":"* ]]; then
              REPO_PART="${IMAGE%:*}"
              TAG_PART="${IMAGE##*:}"
            else
              REPO_PART="$IMAGE"
              TAG_PART="latest"
            fi

            # æ‰å¹³åŒ– repo åï¼ˆæ›¿æ¢ / å’Œ . ä¸º -ï¼Œæ¸…ç†éæ³•å­—ç¬¦ï¼‰
            FLAT_REPO=$(echo "$REPO_PART" | sed 's/[\/.]/-/g' | tr -cd 'a-zA-Z0-9.-_' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
            [ -z "$FLAT_REPO" ] && FLAT_REPO="unknown"

            TARGET_IMAGE="$ACR_TARGET_REGISTRY/$FLAT_REPO:$TAG_PART"
            echo "Tagging as: $TARGET_IMAGE"

            # æ‹‰å– â†’ æ‰“æ ‡ â†’ æ¨é€ â†’ æ¸…ç†
            docker pull "$IMAGE" --platform linux/amd64
            docker tag "$IMAGE" "$TARGET_IMAGE"
            docker push "$TARGET_IMAGE"
            docker rmi "$IMAGE" "$TARGET_IMAGE" 2>/dev/null || true
            docker image prune -f

            echo "<<< Success: $IMAGE â†’ $TARGET_IMAGE"
            echo "----------------------------------------"
          done

          # ç™»å‡ºï¼ˆå¯é€‰ï¼‰
          docker logout "$(echo $ACR_TARGET_REGISTRY | cut -d'/' -f1)"
